<html>
<head>
<script>var isomorphicDir="/isomorphic/";</script>
<script src="/isomorphic/system/modules/ISC_Core.js"></script>
<script src="/isomorphic/system/modules/ISC_Foundation.js"></script>
<script src="/isomorphic/system/modules/ISC_Containers.js"></script>
<script src="/isomorphic/system/modules/ISC_Grids.js"></script>
<script src="/isomorphic/system/modules/ISC_Forms.js"></script>
<script src="/isomorphic/system/modules/ISC_DataBinding.js"></script>
<script src="/isomorphic/skins/TreeFrog/load_skin.js"></script>
</head>
<body>
<script> 
isc.RestDataSource.create({
    ID:"domains",
    dataFormat:"json",
    dataURL:"ds-domains.php",
    transformResponse : function (dsResponse, dsRequest, data) {        
    		var dsResponse = this.Super("transformResponse", arguments);
		for (i=0; i<dsResponse.totalRows; i++)
		{
			if (dsResponse.data[i].domain_id>3)
				dsResponse.data[i].web = "[SKIN]/actions/remove.png";    			
			else dsResponse.data[i].web = "[SKIN]/actions/approve.png";
			if (dsResponse.data[i].domain_id>4) 
				dsResponse.data[i].ftp = "[SKIN]/actions/remove.png";
			else dsResponse.data[i].ftp = "[SKIN]/actions/approve.png";
                        if (i%2==0)
			{
				dsResponse.data[i].dns = "[SKIN]/actions/approve.png";
				dsResponse.data[i].mail = "[SKIN]/actions/approve.png";
			}
			else
			{
				dsResponse.data[i].dns = "[SKIN]/actions/remove.png";
				dsResponse.data[i].mail = "[SKIN]/actions/remove.png";
			}
		}
     		return dsResponse;
		},
    fields:[
        {type: "sequence", name: "domain_id", primaryKey: true},
	{name: "domain_id"},
        {title:"Domain", name:"domain", type: "text",  required: true},
	{name: "web", title: "Web", align:"center",  width:100, type:"image", canFilter:false},
        {name: "enable_ftp", title: "FTP", align:"center",  width:100, type:"image",canFilter:false},
        {name: "dns", title: "DNS", align:"center",  width:100, type:"image", canFilter:false},
        {name: "enable_mail", title: "Mail", align:"center",  width:100, type:"image",canFilter:false}
    ],
    operationBindings:[
       {operationType:"fetch", dataProtocol:"postMessage"},
       {operationType:"add", dataProtocol:"postMessage"},
       {operationType:"remove", dataProtocol:"postMessage"},
       {operationType:"update", dataProtocol:"postMessage"}
    ],
}); 

isc.RestDataSource.create({
    ID:"mailboxes",
    dataFormat:"json",
    dataURL:"ds-mailboxes.php",
    fields:[
        {type: "sequence", name: "mailbox_id", primaryKey: true},
	{name: "mailbox_id"},
	{name: "domain_id"},
	{name: "domain"},
        {title:"Mailbox", name:"mailbox", type: "text",  required: true},
	{name: "addressmail"},
	{name: "copy_on_forward",type:"checkbox"}
    ],
    operationBindings:[
       {operationType:"fetch", dataProtocol:"postMessage"},
       {operationType:"add", dataProtocol:"postMessage"},
       {operationType:"remove", dataProtocol:"postMessage"},
       {operationType:"update", dataProtocol:"postMessage"}
    ],
});

isc.RestDataSource.create({
    ID:"forwards",
    dataFormat:"json",
    dataURL:"ds-forwards.php",
    fields:[
        {type: "sequence", name: "mailbox_forward_id", primaryKey: true},
	{name: "mailbox_forward_id"},
	{name: "mailbox_id"},
	{name: "address",align:"center"}
    ],
    operationBindings:[
       {operationType:"fetch", dataProtocol:"postMessage"},
       {operationType:"add", dataProtocol:"postMessage"},
       {operationType:"remove", dataProtocol:"postMessage"},
       {operationType:"update", dataProtocol:"postMessage"}
    ],
});

isc.RestDataSource.create({
    ID:"aliases",
    dataFormat:"json",
    dataURL:"ds-aliases.php",
    fields:[
        {type: "sequence", name: "global_mail_alias_id", primaryKey: true},
	{name: "global_mail_alias_id"},
	{name: "domain_id"},
        {name:"name", type: "text",  required: true},
	{name: "addressalias", align:"center", canFilter:false}
    ],
    operationBindings:[
       {operationType:"fetch", dataProtocol:"postMessage"},
       {operationType:"add", dataProtocol:"postMessage"},
       {operationType:"remove", dataProtocol:"postMessage"},
       {operationType:"update", dataProtocol:"postMessage"}
    ],
});

isc.RestDataSource.create({
    ID:"aliasesto",
    dataFormat:"json",
    dataURL:"ds-aliasesto.php",
    fields:[
        {type: "sequence", name: "global_mail_alias_to_id", primaryKey: true},
	{name: "global_mail_alias_to_id"},
	{name: "global_mail_alias_id"},
	{name: "address",align:"center"}
    ],
    operationBindings:[
       {operationType:"fetch", dataProtocol:"postMessage"},
       {operationType:"add", dataProtocol:"postMessage"},
       {operationType:"remove", dataProtocol:"postMessage"},
       {operationType:"update", dataProtocol:"postMessage"}
    ],
});
isc.RestDataSource.create({
    ID:"users",
    dataFormat:"json",
    dataURL:"ds-users.php",
    fields:[
        {type: "sequence", name: "user_id", primaryKey: true},
	{name: "user_id"},
	{name: "parent_id"},
	{name: "username"},
	{name: "password"}
    ],
    operationBindings:[
       {operationType:"fetch", dataProtocol:"postMessage"},
       {operationType:"add", dataProtocol:"postMessage"},
       {operationType:"remove", dataProtocol:"postMessage"},
       {operationType:"update", dataProtocol:"postMessage"}
    ],
});

isc.Label.create({
	ID:"label1",
	autoDraw: false,
	width:"100%",
	height:"100%",
	align:"center",
	contents:"Settings for <b>Web</b> Tab"
});
isc.Label.create({
	ID:"label2",
	autoDraw: false,
	width:"100%",
	height:"100%",
	align:"center",
	contents:"VHOSTS for <b>Web</b> Tab"
});
isc.Label.create({
	ID:"label3",
	autoDraw: false,
	width:"100%",
	height:"100%",
	align:"center",
	contents:"Statistics for <b>Web</b> Tab"
});
isc.Label.create({
	ID:"label4",
	autoDraw: false,
	width:"100%",
	height:"100%",
	align:"center",
	contents:"Logs for <b>Web</b> Tab"
});
isc.Label.create({
	ID:"label5",
	autoDraw: false,
	width:"100%",
	height:"100%",
	align:"center",
	contents:"Settings for <b>FTP</b> Tab"
});
pane:isc.Label.create({
	ID:"label6",
	autoDraw: false,
	width:"100%",
	height:"100%",
	align:"center",
	contents:"SmartAuth for <b>FTP</b> Tab"
});
isc.Label.create({
	ID:"label7",
	autoDraw: false,
	width:"100%",
	height:"100%",
	align:"center",
	contents:"Logs for <b>FTP</b> Tab"
});

isc.Label.create({
	ID:"label10",
	autoDraw: false,
	width:"100%",
	height:"100%",
	align:"center",
	contents:"Logs for <b>Mail</b> Tab"
});
isc.Label.create({
	ID:"label11",
	autoDraw: false,
	width:"100%",
	height:"100%",
	align:"center",
	contents:"Auto-Reply for <b>Mail</b> Tab"
});
isc.Label.create({
	ID:"label12",
	autoDraw: false,
	width:"100%",
	height:"100%",
	align:"center",
	contents:"Logs for <b>Mail</b> Tab"
});
isc.ClassFactory.defineClass("TabsPanel", isc.VLayout);

isc.TabsPanel.addProperties({
	width: "80%",
	height: "100%",
	align:"center",
	initWidget: function() {
		this.Super("initWidget", arguments);
	
		this.listGrid = isc.ListGrid.create({
			ID: "listGrid",
			container: this,
			width: "100%",
			height:"30%",
			alternateRecordStyles:true,
			dataSource: isc.DS.get("domains"),
			autoFetchData: true,
			showResizeBar: true,
			recordClick: function (viewer, record){
				stack1.setSectionTitle(2,record.domain.toUpperCase());
				stack1.showSection(2);
				if (stack1.sectionIsExpanded(2)) menu3.show();
				if (stack1.sectionIsExpanded(0)) menu1.show();
				if (stack1.sectionIsExpanded(1)) menu2.show();
				this.container.loadRecord(record);
				mailboxForm.clearErrors(true);
				fwForm.clearErrors(true);
				aliasForm.clearErrors(true);
				aliasToForm.clearErrors(true);
			},
				fields: [
					{name: "domain", title: "Domain",required:"true"},
					{name: "web", title: "Web", align:"center",  width:100, type:"image", canFilter:false},
              
		      			{name: "ftp", title: "FTP", align:"center",  width:100, type:"image",canFilter:false},
                       			{name: "dns", title: "DNS", align:"center",  width:100, type:"image", canFilter:false},
                       			{name: "mail", title: "Mail", align:"center",  width:100, type:"image",canFilter:false}
					],  
		  		autoFitData: "vertical",
		  		showFilterEditor: true,
		  		autoFitMaxRecords: 10
		});

		this.tabWeb=isc.TabSet.create({
                        ID:"tabWeb",
			visibility:"hidden",
			container:this,
			tabs:[	
				{title:"Settings", pane:label1, ID:"settWebTab"},
				{title:"VHOSTS", pane:label2, ID:"vhostWebTab"},
				{title:"Statistics", pane:label3, ID:"statWebTab"},
				{title:"Logs", pane:label4, ID:"logsWebTab"}
			]
              	});

		this.TabMailboxes=isc.TabMailboxes.create();
		this.TabAliases=isc.TabAliases.create();
		this.TabFTPSett=isc.TabFTPSett.create();

		this.tabMail=isc.TabSet.create({
			ID:"tabMail",
			visibility:"hidden",
			
			container:this,
			tabs:[
				{title:"Mailboxes", pane:this.TabMailboxes, ID:"mailboxMailTab"},
				{title:"Global Aliases", pane:this.TabAliases, ID:"fwMailTab"},
				{title:"Catch-all", pane:label10, ID:"catchMailTab"},
				{title:"Auto-Reply", pane:label11, ID:"autoMailTab"},
				{title:"Logs", pane:label12, ID:"logsMailTab"}
			]
		});

		this.tabFTP=isc.TabSet.create({
			ID:"tabFTP",
			visibility:"hidden",
			container:this,
			tabs:[
				{title:"Settings", pane:this.TabFTPSett, ID:"settFTPTab"},
				{title:"SmartAuth", pane:label6, ID:"smartFTPTab"},
				{title:"Logs", pane:label7, ID:"logsFTPTab"}
			]
		});

		
		this.dynamForm=isc.DynamicForm.create({
			ID:"dynamForm",
			container: this,
			dataSource: isc.DS.get("domains"),
			autoDraw: false,
			height: 48,
		       	padding:4,
			fields: [
			{name: "domain", type: "text", title: "Domain",required:"true"}
			]
		});
	
		this.saveButton = isc.IButton.create({
			container: this,
			title: "Save",
			icon: "[SKIN]/actions/save.png",
			click: 
			function () 
				{this.container.saveRecord();}
		});

		this.formLayout=isc.VLayout.create({
			ID:"formLayout",
			width:300,
			height:200,
			padding:50,
			align:"center",
			visibility:"hidden",
			members: [this.dynamForm, this.saveButton]
		});
		
		this.hLayout=isc.HLayout.create({
			ID:"hLayout",
			width:"100%",
			height:"70%",
			border:"1px solid gray",
			members: [this.tabWeb,this.tabMail, this.tabFTP,this.formLayout]
		});	
		
		this.addMember(this.listGrid);
		this.addMember(this.hLayout);
	},
	loadRecord: function(record) {
		this.TabMailboxes.setDomainId(record.domain_id);
		this.TabAliases.setDomainId(record.domain_id);
		//ptr refresh listGrid
		this.TabMailboxes.setMailboxId(0);
		this.TabAliases.setAliasId(0);
		valuesManager.editNewRecord(record);
		aliasForm.editNewRecord(record);
	},
	saveRecord: function() {
		this.dynamForm.saveData(function(dsResponse, data, dsRequest) {
			if (dsResponse.status != 0)
				return;
			if (!this.isNewRecord())
				return;
			this.setSaveOperationType("update"); 
		});
	},

});

isc.ClassFactory.defineClass("TabMailboxes", isc.VLayout);

isc.TabMailboxes.addProperties({
	width: "100%",
	height: "100%",
	align:"center",
	showResizeBar:false,
	initWidget: function() {
		this.Super("initWidget", arguments);
		this.listGrid_Mailboxes=isc.ListGrid.create({
			ID:"listGrid_Mailboxes",
			container:this,
			width:"100%",
			height:"100%",
			alternateRecordStyles:true,
			dataSource: isc.DS.get("mailboxes"),
			autoFetchData: false,
			showResizeBar: false,
			recordClick: function (viewer, record){
				this.container.deleteButton.setDisabled(false);
				this.container.saveButton.setDisabled(false);
				this.container.tabset_Mailboxes.show();
				this.container.valuesManager.editRecord(record);
				this.container.loadFwRecord(record);
				aliasForm.clearErrors(true);
				aliasToForm.clearErrors(true);
				this.container.addButton.setDisabled(false);
				
			},
				fields: [
					{name: "domain_id",showIf:"false"},
					{name: "mailbox_id",showIf:"false"},
					{name: "mailbox", title: "Mailbox",required:"true",canEdit:false},
					{name: "addressmail", title: "Address", align:"center",canFilter:false,canEdit:false}
					],  
		  		autoFitData: "vertical",
		  		showFilterEditor: false,
		  		autoFitMaxRecords: 10
		});
		this.enableMail=isc.DynamicForm.create({
			ID:"enableMail",
			align:"center",
			container: this,
			dataSource: isc.DS.get("domains"),
			fields: [
				{name: "enable_mail", type: "checkbox", title: "Enable local mail delivery"}
			]
		});
		this.applyButton=isc.IButton.create({
			container: this,
			width:110,
			title: "Apply",
			icon: "[SKIN]/actions/approve.png",
			click: function () {this.container.saveApplyRecord();}
		});
		this.enableMailH=isc.HLayout.create({
			showResizeBar:false,
			padding:30,
			width:"80%",
			height:"10%",
			members: [this.enableMail, this.applyButton]
		});
		this.mailboxForm=isc.DynamicForm.create({
			ID:"mailboxForm",
			width:"100%",
			height:"100%",
			align:"center",
			container: this,
			dataSource: isc.DS.get("mailboxes"),
			fields: [
				
				{name: "mailbox", type: "text", title: "Mailbox",required:"true"},
				{name: "password", type: "text", title: "Password",required:"true"}
			]
		});

		this.newButton = isc.IButton.create({
			container: this,
			width:110,
			title: "New Mailbox",
			icon: "[SKIN]/actions/add.png",
			showDisabledIcon: false,
			click: function ()
				{
					this.container.newRecord();
					this.container.mailboxForm.clearErrors(true);
					this.container.tabset_Mailboxes.show();
					this.container.saveButton.setDisabled(false);
					this.container.listGrid_Mailboxes.deselectAllRecords();
					this.container.setMailboxId(0);
					this.container.addButton.setDisabled(true);
				}

		});
		
		this.saveButton = isc.IButton.create({
			container: this,
			width:110,
			title: "Save",
			icon: "[SKIN]/actions/save.png",
			click: function () {this.container.saveRecord();},
			disabled: true
		});
		
		this.deleteButton = isc.IButton.create({
			container: this,
			width:110,
			title: "Delete",
			icon: "[SKIN]/TabSet/close.png",
			showDisabledIcon: "[SKIN]/TabSet/close_Disabled.png",
			disabled: true,
			click: "this.container.deleteRecord();"
		});
		
		this.toolbar = isc.VLayout.create({
			
			members: [this.newButton, this.saveButton, this.deleteButton]
		});

		this.tabH=isc.HLayout.create({
			showResizeBar:true,
			padding:30,
			width:"80%",
			height:"30%",
			members: [this.listGrid_Mailboxes, this.toolbar]
		});

		
		this.listGrid_FwMailboxes=isc.ListGrid.create({
			ID:"listGrid_FwMailboxes",
			container:this,
			width:"100%",
			alternateRecordStyles:true,
			dataSource: isc.DS.get("forwards"),
			autoFetchData: false,
			showResizeBar: false,
			recordClick: function (viewer, record){
				this.container.removeButton.setDisabled(false);
				//this.container.fwForm.editRecord(record);
				this.container.addButton.setDisabled(false);
			},
				fields: [
					{name: "address", title: "Address", align:"center"}
					],  
		  		autoFitData: "vertical",
		  		autoFitMaxRecords: 5
		});
		this.fwForm=isc.DynamicForm.create({
			ID:"fwForm",
			container: this,
			dataSource: isc.DS.get("forwards"),
			fields: [
			{name: "address", type: "text", required:"true"}]
		});
		this.fwCheckForm=isc.DynamicForm.create({
			ID:"fwCheckForm",
			container: this,
			dataSource: isc.DS.get("mailboxes"),
			fields: [
			{name: "copy_on_forward", type: "checkbox", title:"Also leap a local copy"}
			]
		});
		
		this.valuesManager = isc.ValuesManager.create({
			ID:"valuesManager",
			container: this,
			dataSource: isc.DS.get("mailboxes"),
			members: [
				this.mailboxForm,
				this.fwCheckForm
			]
		});
		
		this.addButton = isc.IButton.create({
			container: this,
			title: "Add",
			disabled:false,
			icon: "[SKIN]/actions/add.png",
			click: function () {this.container.saveFwRecord();}
		});
		
		this.removeButton = isc.IButton.create({
			container: this,
			title: "Remove",
			icon: "[SKIN]/TabSet/close.png",
			showDisabledIcon: "[SKIN]/TabSet/close_Disabled.png",
			disabled: true,
			click: "this.container.deleteFwRecord();"
		});
		
		this.fwGridH=isc.HLayout.create({
			showResizeBar:false,
			width:"80%",
			height:"60%",
			padding:30,
			members: [this.listGrid_FwMailboxes, this.removeButton]
		});

		this.fwAddH = isc.HLayout.create({
			showResizeBar:false,
			width:"80%",
			height:"40%",
			padding:30,
			members: [this.fwForm, this.addButton]
		});
		
		this.fwTab=isc.VLayout.create({
			showResizeBar:false,
			members: [this.fwGridH, this.fwAddH,this.fwCheckForm]
		});

		this.tabset_Mailboxes=isc.TabSet.create({
			ID:"tabset_Mailboxes",
			visibility:"hidden",
			height:"70%",
			width:"100%",
			padding:30,
			container:this,
			tabs:[
				{title:"Mailbox", pane:this.mailboxForm, ID:"tab0"},
				{title:"Forwards", pane:this.fwTab, ID:"tab1"}
			]
		});
		this.addMember(this.enableMailH);
		this.addMember(this.tabH);
		this.addMember(this.tabset_Mailboxes);
		this.newRecord();
		
	},
	loadFwRecord: function(record) {
		this.setMailboxId(record.mailbox_id);
		fwForm.editNewRecord({mailbox_id:record.mailbox_id});
	},
	newRecord: function() {
		this.fwForm.editNewRecord({mailbox_id:listGrid_FwMailboxes.container.mailId});
	},
	setDomainId: function(domainId) {
		this.domainId = domainId;
		this.listGrid_Mailboxes.fetchData({domain_id: domainId});
		this.newButton.setDisabled(false);
		this.deleteButton.setDisabled(true);
	},
	setMailboxId: function(mailId) {
		this.mailId = mailId;
		this.listGrid_FwMailboxes.fetchData({mailbox_id: mailId});
		this.removeButton.setDisabled(true);
	},
	saveRecord: function() {
		this.valuesManager.saveData(function(dsResponse, data, dsRequest) {
			if (dsResponse.status != 0)
				return;
			if (!this.isNewRecord())
				return;
			this.setSaveOperationType("update");
		});
	},
	saveFwRecord: function() {
		
		fwForm.saveData(function(dsResponse, data, dsRequest) {
			if (dsResponse.status != 0)
				return;
			if (!this.isNewRecord())
				return;
			this.setSaveOperationType("update");
		});
	this.newRecord();
	},
	saveApplyRecord: function() {
		//enableMail.editRecord({mailbox_id:record.mailbox_id});
		this.enableMail.saveData(function(dsResponse, data, dsRequest) {
			if (dsResponse.status != 0)
				return;
			if (!this.isNewRecord())
				return;
			this.setSaveOperationType("update");
		});
	},
	deleteRecord: function() {
		if (listGrid_Mailboxes.getSelectedRecord()==null) isc.say("Select a mailbox first!");
		else isc.ask("Really delete this mailbox? Will be also deleted the associate forwards addresses.", function (value) {
			if (value)
			{		
				this.container.__deleteRecord();
			}
		}, {container: this});
	},

	__deleteRecord: function() {
		this.listGrid_Mailboxes.dataSource.removeData(this.listGrid_Mailboxes.getSelectedRecord(), { target: this, methodName: "deleteRecordCallback" });
	},

	deleteRecordCallback: function(dsResponse, data, dsRequest) {
		if (dsResponse.status != 0)
			return;
		this.newRecord();
	},
	deleteFwRecord: function() {
		
		isc.ask("Really delete?", function (value) {
			if (value)
				this.container.__deleteFwRecord();
		}, {container: this});
	},

	__deleteFwRecord: function() {
		this.listGrid_FwMailboxes.dataSource.removeData(this.listGrid_FwMailboxes.getSelectedRecord(), { target: this, methodName: "deleteFwRecordCallback" });
	},

	deleteFwRecordCallback: function(dsResponse, data, dsRequest) {
		if (dsResponse.status != 0)
			return;
		this.fwForm.editNewRecord({mailbox_id:listGrid_FwMailboxes.container.mailId});
	},
	domainId: null,
	mailId:null
	
});

isc.ClassFactory.defineClass("TabAliases", isc.VLayout);

isc.TabAliases.addProperties({
	width: "100%",
	height: "100%",
	align:"center",
	showResizeBar:false,
	initWidget: function() {
		this.Super("initWidget", arguments);
		this.listGrid_Aliases=isc.ListGrid.create({
			ID:"listGrid_Aliases",
			container:this,
			width:"100%",
			height:"100%",
			alternateRecordStyles:true,
			dataSource: isc.DS.get("aliases"),
			autoFetchData: false,
			showResizeBar: false,
			recordClick: function (viewer, record){
				this.container.deleteButton.setDisabled(false);
				this.container.aliasToForm.editNewRecord({global_mail_alias_id:record.global_mail_alias_id});
				this.container.loadToRecord(record);
				this.container.addButton.setDisabled(false);
				this.container.newButton.setDisabled(false);
			},
				fields: [
					{name: "domain_id",showIf:"false"},
					{name: "global_mail_alias_id",showIf:"false"},
					{name: "name", title: "Alias",required:"true",canEdit:false},
					{name: "addressalias", title: "Address", align:"center",canFilter:false,canEdit:false}
					],  
		  		autoFitData: "vertical",
		  		showFilterEditor: false,
		  		autoFitMaxRecords: 10
		});
		
		this.deleteButton = isc.IButton.create({
			container: this,
			title: "Remove",
			icon: "[SKIN]/TabSet/close.png",
			showDisabledIcon: "[SKIN]/TabSet/close_Disabled.png",
			disabled: true,
			click: "this.container.deleteRecord();"
		});
		this.aliasForm=isc.DynamicForm.create({
			ID:"aliasForm",
			container: this,
			width:"100%",
			dataSource: isc.DS.get("aliases"),
			fields: [
			{name: "name",type: "text", required:"true",width:500}],
		});
		this.newButton = isc.IButton.create({
			container: this,
			title: "New",
			icon: "[SKIN]/actions/add.png",
			showDisabledIcon: false,
			click: function ()
				{	
					this.container.saveRecord();
				}

		});
		this.AliasGridH = isc.HLayout.create({
			showResizeBar:false,
			
			members: [this.listGrid_Aliases, this.deleteButton]
		});
		this.AliasAddH = isc.HLayout.create({
			showResizeBar:false,
			members: [this.aliasForm, this.newButton]
		});

		this.Alias=isc.VLayout.create({
			showResizeBar:true,
			padding:30,
			width:"80%",
			height:"30%",
			members: [this.AliasGridH, this.AliasAddH]
		});

		this.listGrid_AliasTo=isc.ListGrid.create({
			ID:"listGrid_AliasTo",
			container:this,
			width:"100%",
			alternateRecordStyles:true,
			dataSource: isc.DS.get("aliasesto"),
			autoFetchData: false,
			showResizeBar: false,
			recordClick: function (viewer, record){
				this.container.removeButton.setDisabled(false);
				//this.container.aliasForm.editRecord(record);
				this.container.addButton.setDisabled(false);
			},
			fields: [
				{name: "address", align:"center"}
				],  
		  	autoFitData: "vertical",
		  	autoFitMaxRecords: 5
		});
		
		this.aliasToForm=isc.DynamicForm.create({
			ID:"aliasToForm",
			container: this,
			dataSource: isc.DS.get("aliasesto"),
			fields: [
			{name: "address", type: "text", required:"true"}]
		});

		this.addButton = isc.IButton.create({
			container: this,
			title: "Add",
			disabled:true,
			icon: "[SKIN]/actions/add.png",
			click: function () {this.container.saveToRecord();}
		});
		this.removeButton = isc.IButton.create({
			container: this,
			title: "Remove",
			icon: "[SKIN]/TabSet/close.png",
			showDisabledIcon: "[SKIN]/TabSet/close_Disabled.png",
			disabled: true,
			click: "this.container.deleteToRecord();"
		});
		
		this.AliasToGridH=isc.HLayout.create({
			showResizeBar:false,
			width:"80%",
			height:"60%",
			padding:30,
			members: [this.listGrid_AliasTo, this.removeButton]
		});

		this.AliasToAddH = isc.HLayout.create({
			showResizeBar:false,
			width:"80%",
			height:"40%",
			padding:30,
			members: [this.aliasToForm, this.addButton]
		});
		
		this.AliasTo=isc.VLayout.create({
			showResizeBar:false,
			
			members: [this.AliasToGridH, this.AliasToAddH]
		});

		this.addMember(this.Alias);
		this.addMember(this.AliasTo);
	},
	setDomainId: function(domainId) {
		this.domainId = domainId;
		this.listGrid_Aliases.fetchData({domain_id: domainId});
		this.newButton.setDisabled(false);
		this.deleteButton.setDisabled(true);
	},
	loadToRecord: function(record) {
		this.setAliasId(record.global_mail_alias_id);
		aliasForm.editNewRecord(record);
	},
	newRecord: function() {
		this.alisForm.editNewRecord({domain_id:listGrid_Aliases.container.domainId});
	},
	setAliasId: function(aliasId) {
		this.aliasId = aliasId;
		this.listGrid_AliasTo.fetchData({global_mail_alias_id: aliasId});
		this.removeButton.setDisabled(true);
	},
	saveRecord: function() {
		this.aliasForm.saveData(function(dsResponse, data, dsRequest) {
			if (dsResponse.status != 0)
				return;
			if (!this.isNewRecord())
				return;
			this.setSaveOperationType("update");
		});
	this.aliasForm.editNewRecord({domain_id:listGrid_Aliases.container.domainId});
	},
	saveToRecord: function() {
		this.aliasToForm.saveData(function(dsResponse, data, dsRequest) {
			if (dsResponse.status != 0)
				return;
			if (!this.isNewRecord())
				return;
			this.setSaveOperationType("update");
		});
	this.aliasToForm.editNewRecord({global_mail_alias_id:listGrid_AliasTo.container.aliasId});
	},
	deleteRecord: function() {
		if (listGrid_Aliases.getSelectedRecord()==null) isc.say("Select a alias first!");
		else isc.ask("Really delete?", function (value) {
			if (value)
				this.container.__deleteRecord();
		}, {container: this});
	},

	__deleteRecord: function() {
		this.listGrid_Aliases.dataSource.removeData(this.listGrid_Aliases.getSelectedRecord(), { target: this, methodName: "deleteRecordCallback" });
	},

	deleteRecordCallback: function(dsResponse, data, dsRequest) {
		if (dsResponse.status != 0)
			return;
		//this.newRecord();
	},
	deleteToRecord: function() {
		
		isc.ask("Really delete?", function (value) {
			if (value)
				this.container.__deleteToRecord();
		}, {container: this});
	},

	__deleteToRecord: function() {
		this.listGrid_AliasTo.dataSource.removeData(this.listGrid_AliasTo.getSelectedRecord(), { target: this, methodName: "deleteToRecordCallback" });
	},

	deleteToRecordCallback: function(dsResponse, data, dsRequest) {
		if (dsResponse.status != 0)
			return;
		this.aliasToForm.editNewRecord({global_mail_alias_id:listGrid_AliasTo.container.aliasId});
	},
	domainId: null,
	aliasId:null
});

isc.ClassFactory.defineClass("TabFTPSett", isc.VLayout);

isc.TabFTPSett.addProperties({
	width: "100%",
	height: "100%",
	padding:30,
	align:"center",
	showResizeBar:false,
	initWidget: function() {
		this.Super("initWidget", arguments);
		this.settForm=isc.DynamicForm.create({
		    ID: "settForm",
		    dataSource: isc.DS.get("users"),
		    fields: [
			{name:"username",canEdit:false},
			{name: "password",required: true,type: "password"},
			{name: "password_confirm", title: "Confirm", type: "password", required: true, 
			 length: 20, validators: [{
			     type: "matchesField",
			     otherField: "password",
			     errorMessage: "Passwords do not match"
			 }]
			},
			{name:"ftp_check", type:"checkbox", title:"Enable FTP Access"}
		    ],values:{username:"gigi"}
		});
		this.saveButton = isc.IButton.create({
			container: this,
			title: "Save",
			icon: "[SKIN]/actions/save.png",
			click: function () {this.container.saveRecord();},
		});

		this.TabSett=isc.VLayout.create({
			members:[this.settForm, this.saveButton]		
		});
		this.addMember(this.TabSett);
	},
	saveRecord: function() {
		this.settForm.saveData(function(dsResponse, data, dsRequest) {
			if (dsResponse.status != 0)
				return;
			if (!this.isNewRecord())
				return;
			this.setSaveOperationType("update");
		});
	}
});
isc.ClassFactory.defineClass("MenuPanel", isc.VLayout);

isc.MenuPanel.addProperties({
	width: "20%",
	height: "100%",
	align:"center",
	showResizeBar:true,
	initWidget: function() {
		this.Super("initWidget", arguments);
		this.menu1= isc.Menu.create({ 
                        ID:"menu1",
			cellHeight:20,
			container:this,
			width:150,
			height:100,
		 	showShadow: false,
			align:"center",
			autoDraw:true,
			autoDismiss:true,
			data:[
				{
				title:"Domains",
				icon:"[SKINIMG]/SchemaViewer/complexType.gif",
			    	click:function () 
					{
						if (stack1.sectionIsExpanded(0)) menu1.show(); 
						if (stack1.sectionIsExpanded(1)) menu2.show(); 
						if (listGrid.getSelectedRecord() != null && stack1.sectionIsExpanded(2))  menu3.show();
						tabWeb.hide();
						tabFTP.hide();
						tabMail.hide();
						formLayout.hide();
					}
				},
		   
				{
				title:"Databases",
				icon:"[SKINIMG]/DatabaseBrowser/data.png",
				click: function () 
					{
						if (stack1.sectionIsExpanded(0)) menu1.show(); 
						if (stack1.sectionIsExpanded(1)) menu2.show(); 
						if (listGrid.getSelectedRecord() != null && stack1.sectionIsExpanded(2))  menu3.show();
						tabWeb.hide();
						tabFTP.hide();
						tabMail.hide();
						formLayout.hide();
					}
				},
				{
				title:"System",
				icon:"[SKINIMG]/Window/headerIcon.png",
				click: function () 
					{
						if (stack1.sectionIsExpanded(0)) menu1.show(); 
						if (stack1.sectionIsExpanded(1)) menu2.show(); 
						if (listGrid.getSelectedRecord() != null && stack1.sectionIsExpanded(2))  menu3.show();
						tabWeb.hide();
						tabFTP.hide();
						tabMail.hide();
						formLayout.hide();
					}
				},
				{
				title:"Logout",
				icon:"[SKINIMG]/Window/headerIcon.png",
				click: function () 
					{
						if (stack1.sectionIsExpanded(0)) menu1.show(); 
						if (stack1.sectionIsExpanded(1)) menu2.show(); 
						if (listGrid.getSelectedRecord() != null && stack1.sectionIsExpanded(2))  menu3.show();
						tabWeb.hide();
						tabFTP.hide();
						tabMail.hide();
						formLayout.hide();
					}
				}
			]  
		  });

		this.menu2= isc.Menu.create({ 
                        ID:"menu2",
			cellHeight:20,
			container:this,
			width:150,
			height:75,
			showShadow: false,
			align:"center",
			autoDraw:true,
			data:[
				{
				title:"New Domain",
				icon:"[SKINIMG]/actions/add.png",
				click:function () 
					{ 
						if (stack1.sectionIsExpanded(0)) menu1.show();  
						if (stack1.sectionIsExpanded(1))  menu2.show(); 
						if (listGrid.getSelectedRecord() != null && stack1.sectionIsExpanded(2))  menu3.show();
						tabWeb.hide();
						tabFTP.hide();
						tabMail.hide();
						formLayout.show();
						
					}
				},
				{title:"Wizard",
				icon:"[SKINIMG]/RichTextEditor/link_new.png",
				click:function () 
					{ 
						if (stack1.sectionIsExpanded(0)) menu1.show();  
						if (stack1.sectionIsExpanded(1))  menu2.show();  
						if (listGrid.getSelectedRecord() != null && stack1.sectionIsExpanded(2)) menu3.show();
						tabWeb.hide();
						tabFTP.hide();
						tabMail.hide();
						formLayout.hide();
						
					}
				},
				{title:"Remove",
				icon:"[SKINIMG]/actions/remove.png",
				container:this,
				click:function () 
					{ 
						if (stack1.sectionIsExpanded(0)) menu1.show();  
						if (stack1.sectionIsExpanded(1))  menu2.show();  
						if (listGrid.getSelectedRecord() != null && stack1.sectionIsExpanded(2)) menu3.show();
						tabWeb.hide();
						tabFTP.hide();
						tabMail.hide();
						formLayout.hide();
						if (listGrid.getSelectedRecord() != null) this.container.deleteRecord(); 
							else isc.say('Select a domain first!');
					}
				}
			]  
		 });

		this.menu3= isc.Menu.create({ 
                        ID:"menu3",
			cellHeight:20,
			container:this,
			width:150,
			height:125,
			visibility:"hidden",
			showShadow: false,
			autoDraw:true,
			align:"center",
                    
			data:[
				{
				title:"Summary",
				icon:"[SKINIMG]/FileBrowser/file.png",
				click: function ()
					{
					    	if (stack1.sectionIsExpanded(0)) menu1.show();  
					     	if (stack1.sectionIsExpanded(1))  menu2.show();  
					     	menu3.show();
						tabWeb.hide();
						tabFTP.hide();
						tabMail.hide();
						formLayout.hide();
						
					}
				},
				{
				title:"Web",
				icon:"[SKINIMG]/Window/headerIcon.png",
				click:function ()
                                	{ 
						if (stack1.sectionIsExpanded(0)) menu1.show();  
						if (stack1.sectionIsExpanded(1))  menu2.show();  
						menu3.show();
						tabWeb.show();
						tabFTP.hide();
						tabMail.hide();
						formLayout.hide();
		                                tabWeb.selectTab(0);
                                	}
				},
			       	{
				title:"FTP",
				icon:"[SKINIMG]/FileBrowser/folder.png",
				click:function ()
                                     	{
		                                if (stack1.sectionIsExpanded(0)) menu1.show();  
						if (stack1.sectionIsExpanded(1))  menu2.show();  
						menu3.show();
						tabWeb.hide();
						tabFTP.show();
						tabMail.hide();
						formLayout.hide();
		                                tabFTP.selectTab(0);
                                        }
				},
				{
				title:"Mail",
				icon:"[SKINIMG]/Window/headerIcon.png",
				click:function ()
                                        { 
						if (stack1.sectionIsExpanded(0)) menu1.show();  
						if (stack1.sectionIsExpanded(1))  menu2.show();  
						menu3.show();  
						tabFTP.hide();
						tabMail.show();
						formLayout.hide();                                  	
						tabMail.selectTab(0);
                                        }
				},
				{
				title:"DNS",
				icon:"[SKINIMG]/Window/headerIcon.png",
				click: function ()
					{
					     	if (stack1.sectionIsExpanded(0)) menu1.show();  
					     	if (stack1.sectionIsExpanded(1))  menu2.show();  
					     	menu3.show();
						tabWeb.hide();
						tabFTP.hide();
						tabMail.hide();
						formLayout.hide();
					}
			       	}
			] 
		  });
		
		this.stack1=isc.SectionStack.create({
		   	ID: "stack1",
			container:this,
			visibilityMode: "multiple",
		    	width:	152,
			height: 500,
			align:"center",
		    	sections: [
			{title: "MENU", expanded: true,width: 152,align:"center", items: [this.menu1],
				click: function (){
					     if (stack1.sectionIsExpanded(1)) menu2.show(); 
					     if (listGrid.getSelectedRecord() != null && stack1.sectionIsExpanded(2)) menu3.show();}},
			{title: "ACTIONS", expanded: true, items: [this.menu2],
				click: function (){
					     if (stack1.sectionIsExpanded(0)) menu1.show(); 
					     if (listGrid.getSelectedRecord() != null && stack1.sectionIsExpanded(2)) menu3.show();}},
			{title: "d", expanded: true, items: [this.menu3],
				click: function (){
					      if (stack1.sectionIsExpanded(0)) menu1.show(); 
					      if (stack1.sectionIsExpanded(1)) menu2.show();}}
		    ]
		});
		
		this.addMember(this.stack1);

	},

	deleteRecord: function() {
		isc.ask("Really delete?", function (value) {
			if (value)
				this.container.__deleteRecord();
		}, {container: this});
	},

	__deleteRecord: function() {
		listGrid.dataSource.removeData(listGrid.getSelectedRecord(), { target: this, methodName: "deleteRecordCallback" });
	},

	deleteRecordCallback: function(dsResponse, data, dsRequest) {
		if (dsResponse.status != 0)
			return;
		stack1.hideSection(2);
	}
});

isc.ClassFactory.defineClass("PanelView", isc.HLayout);

isc.PanelView.addProperties({
	width: "100%",
	height: "100%",
	initWidget: function() {
		this.Super("initWidget", arguments);
		
		this.MenuPanel=isc.MenuPanel.create();
		this.TabsPanel=isc.TabsPanel.create();
		this.addMember(this.MenuPanel);
		this.addMember(this.TabsPanel);
		this.loadinit();
	},

        loadinit: function()
        {
             if (listGrid.getSelectedRecord() == null) stack1.hideSection(2); 
        }
});
isc.PanelView.create();

</script>
</body>
</html>
